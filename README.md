markdown
# 插件开发文档：astrbot_plugin_link_context_reader

## 插件简介

`astrbot_plugin_link_context_reader` 是一款专为 AstrBot 设计的智能上下文增强插件。旨在解决大语言模型（LLM）无法直接访问互联网链接内容的痛点。

当用户发送包含 URL 的消息时，本插件会在请求发送给 LLM 之前，自动拦截并解析链接指向的内容。无论是普通网页新闻、技术博客，还是小红书、知乎、微博等社交平台的帖子，甚至是音乐分享链接，插件都能提取核心文本或歌词，将其注入到当前的对话上下文中。这使得 LLM 能够基于最新的网络内容回答用户的问题，例如总结文章摘要、分析社交媒体观点或解读歌词含义。

## 功能说明

1.  **自动链接检测与拦截**：
    *   实时监听用户消息，智能识别其中的 URL。
    *   支持混合文本检测（如：“帮我看看这篇文章讲了什么 https://...”）。

2.  **多模态/多平台解析引擎**：
    *   **通用网页**：利用 `BeautifulSoup` 和 `Readability` 算法提取网页正文，自动去除广告和导航栏干扰。
    *   **社交媒体适配**：针对 **小红书、知乎、微博、LOFTER** 进行了专门适配，能够精确提取帖子标题、正文内容及关键评论。
    *   **音乐歌词增强**：识别主流音乐平台（网易云音乐、QQ音乐等）的分享链接，自动解析歌曲名和歌手，并检索对应的歌词内容。

3.  **LLM 上下文注入**：
    *   获取的内容不会直接作为回复发送，而是作为“补充知识”无缝注入到 LLM 的 `System Prompt` 或当前用户消息的 Prompt 中。
    *   LLM 能够“阅读”链接内容，并根据用户的指令（如总结、评价、翻译）生成回复。

4.  **功能开关控制**：
    *   提供指令随时开启或暂停解析服务，避免在不需要时消耗资源或 Token。

## 插件流程

本插件主要依赖 AstrBot 的事件钩子机制（Event Hooks）来实现无感知的上下文增强。核心工作流程如下：

1.  **事件监听 (Event Listening)**：
    *   插件注册 `filter.on_llm_request()` 钩子。该钩子在 AstrBot 接收到用户消息并准备向 LLM 服务商发起请求之前触发。
    *   在此阶段，插件可以访问并修改 `ProviderRequest` 对象（包含发送给 LLM 的最终文本）。

2.  **URL 提取与路由 (Extraction & Routing)**：
    *   插件检查 `event.message_str` 中是否存在 URL。
    *   如果存在 URL，插件会根据域名特征将任务分发给不同的处理模块：
        *   **SocialHandler**: 处理知乎、微博、小红书等特定结构页面。
        *   **MusicHandler**: 处理音乐链接，触发元数据提取和歌词搜索逻辑。
        *   **GenericHandler**: 处理通用 HTML 页面。

3.  **异步内容获取 (Async Fetching)**：
    *   使用 `aiohttp` 进行异步网络请求，确保不阻塞主线程。
    *   对于通用网页，使用 `lxml` 和 `cssselect` 清洗 DOM 树，移除 `<script>`, `<style>` 等无用标签，提取 `<p>`, `<article>` 等核心内容。
    *   对于音乐链接，根据抓取到的 `<title>` (如 "歌曲名 - 歌手") 调用内部歌词接口获取文本。

4.  **Prompt 增强 (Context Injection)**：
    *   获取到的文本内容会被截断（防止超出 Token 限制，默认可配置）。
    *   插件构建增强后的提示词，格式示例：
        