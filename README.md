markdown
# 插件文档: astrbot_plugin_link_reader

## 插件简介

`astrbot_plugin_link_reader` 是一款专为 AstrBot 设计的 LLM 上下文增强插件。旨在解决大语言模型无法直接访问互联网链接的问题。当用户发送的消息中包含 URL 时，该插件会在请求 LLM 之前（利用 `on_llm_request` 钩子）自动拦截，根据链接类型智能抓取或检索相关内容，并将这些信息无缝注入到对话上下文中。这意味着您的 Bot 将能够“阅读”新闻、总结视频内容、甚至根据歌曲链接查找歌词和乐评，从而给出更精准的回答。

## 功能说明

### 1. 多模态链接解析与增强
插件能够识别不同类型的链接并采取针对性的处理策略：
*   **普通网页**：自动抓取网页 HTML，提取正文内容（去除广告和导航栏），让 LLM 获取网页核心信息。
*   **音乐链接智能处理**：针对主流音乐平台的链接，插件**不**直接爬取播放页，而是提取歌曲名和歌手信息，利用搜索引擎（如 DuckDuckGo）自动检索该歌曲的完整歌词及热门评论/评价，构建更丰富的背景知识。
*   **深度适配社交平台**：内置针对特定平台的解析器，支持 **小红书、LOFTER、知乎、B站 (Bilibili)、抖音、贴吧、微博**。针对这些通常具有反爬策略的平台，支持通过配置 Cookie 来获取完整的帖子内容、评论区或视频简介。

### 2. 无感注入
解析过程完全自动化。抓取到的文本内容会自动附加到用户的原始提示词（Prompt）之后，并辅以系统提示，明确告知 LLM “以下是链接的具体内容”。用户无需改变提问习惯，只需在消息中附带链接即可。

### 3. 调试与状态监控
提供指令用于调试解析效果和检查 Cookie 有效性，方便管理员维护。

## 插件流程

本插件主要依赖 AstrBot 的 `on_llm_request` 事件钩子，具体工作流程如下：

1.  **事件触发**：当 AstrBot 接收到消息并准备调用 LLM（触发 `on_llm_request`）时，插件介入。
2.  **链接提取**：检查用户发送的消息内容（`text`）中是否存在 URL。如果不存在，直接放行，不影响原有流程。
3.  **策略分发**：
    *   **音乐类 URL**：识别为音乐平台链接 -> 提取元数据（歌名/歌手） -> 调用搜索工具检索“歌词+评价” -> 整合搜索结果。
    *   **社交媒体 URL**：识别为特定平台域名 -> 检查配置文件中是否填有对应平台的 Cookie -> 使用 Cookie 模拟请求（或使用无 Cookie 的公开接口降级处理）-> 提取帖子正文、热评等结构化数据。
    *   **通用 URL**：不属于上述类别 -> 发起标准 HTTP GET 请求 -> 使用 `BeautifulSoup` 或 `Readability` 算法提取网页主要文本。
4.  **内容截断与清洗**：为防止 token 溢出，对提取的文本进行清洗（去除 HTML 标签、脚本）和智能截断。
5.  **Prompt 注入**：
    *   修改 `ProviderRequest` 对象。
    *   将处理后的文本以 `【链接参考内容】：...` 的格式追加到用户的 prompt 中。
    *   （可选）在系统提示词（System Prompt）中增加指令，引导 LLM 基于参考内容回答。
6.  **LLM 生成**：LLM 接收到包含原始问题和链接内容的完整提示词，生成回复。

## 使用方法

### 基础用法

安装并启用插件后，直接在对话中发送链接即可。

*   **场景 1：总结文章**
    *   **用户**：帮我总结一下这篇文章的观点 https://example.com/news/123
    *   **Bot**：（后台自动抓取内容）这篇文章主要讨论了……

*   **场景 2：询问歌曲含义**
    *   **用户**：这首歌主要表达了什么情感？https://music.163.com/song?id=xxxx
    *   **Bot**：（后台搜索歌词和乐评）这就歌名为《xxx》，歌词描绘了……网友评价认为它表达了……

*   **场景 3：解析小红书帖子**
    *   **用户**：看看这个攻略靠谱吗 https://www.xiaohongshu.com/explore/xxxx
    *   **Bot**：（利用 Cookie 读取笔记详情）根据笔记内容，博主推荐了……

### 指令列表

| 指令 | 描述 | 示例 |
| :--- | :--- | :--- |
| `/link_debug [url]` | **调试模式**。发送此指令加链接，插件会返回抓取到的**原始文本内容**，而不会请求 LLM。用于测试链接是否能被成功解析。 | `/link_debug https://www.zhihu.com/question/123` |
| `/link_status` | **状态检查**。查看当前配置的各平台 Cookie 状态（是否填写）、解析器健康状况以及依赖库版本。 | `/link_status` |

## 配置说明

为了获取某些强风控平台（如知乎、微博、小红书等）的完整内容，建议在插件配置中填写对应平台的 Cookie。

配置文件通常位于 `data/config/astrbot_plugin_link_reader_config.json`，或通过 AstrBot 管理面板直接配置。

### 配置项详解

| 配置项字段 | 类型 | 必填 | 说明 |
| :--- | :--- | :--- | :--- |
| `user_agent` | string | 否 | 自定义请求头中的 User-Agent，建议填写浏览器 UA 以降低被拦截概率。 |
| `max_length` | int | 否 | 抓取内容的最大字符数限制，默认为 2000，防止超出 LLM 上下文窗口。 |
| `cookies` | object | 否 | 社交平台的 Cookie 配置集合。 |
| └ `zhihu` | string | 否 | 知乎的 Cookie 字符串。 |
| └ `weibo` | string | 否 | 微博的 Cookie 字符串。 |
| └ `xiaohongshu` | string | 否 | 小红书的 Cookie 字符串（关键参数通常为 `web_session`）。 |
| └ `bilibili` | string | 否 | B站的 Cookie (SESSDATA 等)。 |
| └ `douyin` | string | 否 | 抖音的 Cookie (ttwid 等)。 |
| `enable_search` | bool | 是 | 是否启用音乐链接的搜索引擎辅助功能。默认为 `true`。 |

**配置示例 (JSON):**
